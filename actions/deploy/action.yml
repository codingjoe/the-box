name: Deploy
description: 'Deploy the application to the production server using Docker Compose. This action connects to the production server via SSH, sets up a Docker context, and runs the necessary Docker Compose commands to deploy the application.'
branding:
  icon: 'anchor'
  color: 'blue'
inputs:
  ssh-host:
    description: 'The hostname or IP address of the production server (e.g., "example.com").'
    required: true
  ssh-known-hosts:
    description: 'The SSH known hosts entry for the production server (e.g., "github.com ssh-rsa ...").'
    required: true
  hostname:
    description: 'The hostname to use for the application (e.g., "example.com").'
    required: true
  ssh-private-key:
    description: 'The SSH private key to use for connecting to the production server. This should be stored as a secret in the repository.'
    required: true
  dotenv-private-key:
    description: 'The private key to use for encrypting secrets in the .env file on the production server. This should be stored as a secret in the repository.'
    required: true
  project-name:
    description: 'The project name to use for Docker Compose (e.g., "myapp"). This will be used as the prefix for container names and other resources.'
    required: true
runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v6
    - uses: webfactory/ssh-agent@v0.9.1
      with:
        ssh-private-key: ${{ inputs.ssh-private-key }}
    - name: Pin known hosts
      run: |
        echo "::group::Pinning known hosts"
        echo "${{ inputs.ssh-known-hosts }}" >> ~/.ssh/known_hosts
        echo "::debug::Known hosts updated:"
        cat ~/.ssh/known_hosts
        echo "::endgroup::"
      shell: sh
    - name: Setting up Docker context for remote deployment
      run: |
        docker context create production --description "Production Server" --docker "host=ssh://github@${{ inputs.ssh-host }}"
        docker context use production
      shell: sh
    - uses: codingjoe/the-box/actions/compose@main
    - name: Deploy production containers
      run: docker compose --file compose.yml --project-name ${{ inputs.project-name }}  up --detach --quiet-pull
      shell: sh
      env:
        HOSTNAME: ${{ inputs.hostname }}
        DOTENV_PRIVATE_KEY_PRODUCTION: ${{ inputs.dotenv-private-key }}
